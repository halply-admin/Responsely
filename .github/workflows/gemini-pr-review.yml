# .github/workflows/pr-gemini-review.yml
name: Gemini PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  gemini-pr-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gemini CLI
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          gemini_model: gemini-1.5-pro-latest
          gemini_debug: true
          prompt: |
            You are a senior code reviewer. Review the pull request in **${{ github.repository }}**.
            Provide feedback in markdown with these sections:
            ## Summary
            ## Strengths
            ## Concerns
            ## Suggestions
            Be constructive, concise, and actionable.

      - name: Post Gemini feedback to PR
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const feedback = `${{ steps.gemini.outputs.gemini_response }}`;
            const errors = `${{ steps.gemini.outputs.gemini_errors }}`;
            let body = "";

            if (feedback && feedback.trim() !== "") {
              body = "ü§ñ Gemini Review:\n\n" + feedback;
            } else if (errors && errors.trim() !== "") {
              body = "‚ö†Ô∏è Gemini failed:\n\n```\n" + errors + "\n```";
            } else {
              body = "No feedback was generated by Gemini.";
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
